<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API密钥号池</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
            }
            .login-card {
                max-width: 400px;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
    <!-- 登录界面 -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="login-card bg-white rounded-xl card-shadow p-8">
            <div class="text-center mb-6">
                <i class="fa fa-key text-primary text-4xl mb-4"></i>
                <h1 class="text-2xl font-bold text-dark">Gemini API密钥号池</h1>
                <p class="text-gray-500 mt-2">请输入密码访问控制面板</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all pr-10">
                        <i class="fa fa-eye absolute right-3 top-3 text-gray-400 cursor-pointer" id="toggle-password"></i>
                    </div>
                </div>
                <div id="login-error" class="hidden text-danger text-sm"></div>
                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center justify-center">
                    <i class="fa fa-sign-in mr-2"></i>登录
                </button>
            </form>
        </div>
    </div>

    <!-- 主界面 (默认隐藏) -->
    <div id="main-screen" class="hidden min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 mb-4 md:mb-0">
                    <i class="fa fa-key text-primary text-2xl"></i>
                    <h1 class="text-2xl font-bold text-dark">Gemini API密钥号池</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="font-medium">后端服务状态:</span>
                        <span id="service-status-indicator" class="status-indicator bg-warning"></span>
                        <span id="service-status-text" class="text-warning font-medium">检查中...</span>
                    </div>
                    <button id="refresh-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                        <i class="fa fa-refresh mr-2"></i>刷新
                    </button>
                    <button id="logout-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-all duration-300 flex items-center">
                        <i class="fa fa-sign-out mr-2"></i>退出
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- 转发URL区域 -->
            <div class="bg-gradient-to-r from-primary/90 to-primary rounded-xl p-6 text-white mb-8 card-shadow">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div>
                        <h2 class="text-xl font-bold mb-2">统一访问接口</h2>
                        <p class="opacity-90 mb-4 md:mb-0">使用此URL访问Gemini API，系统会自动分配可用密钥</p>
                    </div>
                    <div class="w-full md:w-auto">
                        <div class="flex items-center bg-white/10 rounded-lg p-3 w-full">
                            <input type="text" id="proxy-url" readonly 
                                class="bg-transparent border-none text-white font-mono flex-grow focus:outline-none"
                                value="加载中...">
                            <button onclick="copyProxyUrl()" class="ml-2 text-white hover:text-gray-200 transition-colors">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-sm opacity-80 mt-2">点击复制URL，无需手动指定API密钥</p>
                    </div>
                </div>
            </div>
            
            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 mb-1">总密钥数</p>
                            <h3 id="total-keys" class="text-3xl font-bold text-dark">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                            <i class="fa fa-list text-primary text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 mb-1">可用密钥</p>
                            <h3 id="active-keys" class="text-3xl font-bold text-secondary">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center">
                            <i class="fa fa-check-circle text-secondary text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 card-shadow transform transition-all duration-300 hover:scale-[1.02]">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 mb-1">今日请求数</p>
                            <h3 id="today-requests" class="text-3xl font-bold text-warning">0</h3>
                        </div>
                        <div class="w-12 h-12 bg-warning/10 rounded-full flex items-center justify-center">
                            <i class="fa fa-exchange text-warning text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 密钥列表 -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-dark">API密钥列表</h2>
                    <p class="text-gray-500 mt-1">显示所有Gemini API密钥及其状态</p>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">密钥ID</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">密钥（部分隐藏）</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">剩余额度</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">今日使用次数</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">上次检查</th>
                                <th class="px-6 py-4 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="keys-table-body" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-20 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fa fa-spinner fa-spin text-primary text-3xl mb-4"></i>
                                        <p>加载密钥数据中...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 添加密钥表单 -->
            <div class="mt-8 bg-white rounded-xl card-shadow p-6">
                <h2 class="text-xl font-bold text-dark mb-4">添加新密钥</h2>
                <form id="add-key-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1">API密钥</label>
                            <input type="text" id="api-key" name="api-key" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        </div>
                        <div>
                            <label for="key-name" class="block text-sm font-medium text-gray-700 mb-1">密钥名称（可选）</label>
                            <input type="text" id="key-name" name="key-name"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        </div>
                    </div>
                    <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all duration-300 flex items-center">
                        <i class="fa fa-plus mr-2"></i>添加密钥
                    </button>
                </form>
            </div>
            
            <!-- 调用示例 -->
            <div class="mt-8 bg-white rounded-xl card-shadow p-6">
                <h2 class="text-xl font-bold text-dark mb-4">调用示例</h2>
                <div class="bg-gray-50 p-4 rounded-lg font-mono text-sm overflow-x-auto">
                    <p class="mb-2 text-gray-700">使用curl调用：</p>
                    <pre class="text-gray-900">curl -X POST <span id="curl-example-url">https://your-domain.com/api/proxy</span> \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gemini-pro",
    "contents": [
      {
        "parts": [{"text": "Hello, world!"}]
      }
    ]
  }'</pre>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="bg-dark text-white py-6">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2023 Gemini API密钥号池系统 | 部署于Cloudflare</p>
            </div>
        </footer>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
        <i id="notification-icon" class="mr-2"></i>
        <span id="notification-message"></span>
    </div>

    <script>
        const API_BASE_URL = '/api';
        const PROXY_URL = `${window.location.origin}${API_BASE_URL}/proxy`;
        const AUTH_TOKEN_KEY = 'gemini_key_pool_auth';
        
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                login();
            });
            document.getElementById('toggle-password').addEventListener('click', togglePasswordVisibility);
            document.getElementById('logout-btn').addEventListener('click', logout);
        });
        
        function checkAuthentication() {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            if (token) {
                validateToken(token)
                    .then(valid => valid ? showMainScreen() : showLoginScreen())
                    .catch(() => showLoginScreen());
            } else {
                showLoginScreen();
            }
        }
        
        async function validateToken(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/validate`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }
        
        async function login() {
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    const { token } = await response.json();
                    localStorage.setItem(AUTH_TOKEN_KEY, token);
                    showMainScreen();
                    errorEl.classList.add('hidden');
                } else {
                    errorEl.textContent = '密码错误，请重试';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                errorEl.textContent = '登录失败，请检查网络';
                errorEl.classList.remove('hidden');
            }
        }
        
        function logout() {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            showLoginScreen();
            showNotification('已退出登录', 'success');
        }
        
        function togglePasswordVisibility() {
            const input = document.getElementById('password');
            const icon = document.getElementById('toggle-password');
            input.type = input.type === 'password' ? 'text' : 'password';
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-screen').classList.add('hidden');
        }
        
        function showMainScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            initMainScreen();
        }
        
        function initMainScreen() {
            document.getElementById('proxy-url').value = PROXY_URL;
            document.getElementById('curl-example-url').textContent = PROXY_URL;
            checkServiceStatus();
            loadKeys();
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadKeys();
                checkServiceStatus();
            });
            document.getElementById('add-key-form').addEventListener('submit', (e) => {
                e.preventDefault();
                addNewKey();
            });
            setInterval(() => { loadKeys(); checkServiceStatus(); }, 30000);
        }
        
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            const response = await fetch(url, {
                ...options,
                headers: { ...options.headers, 'Authorization': `Bearer ${token}` }
            });
            
            if (response.status === 401) {
                localStorage.removeItem(AUTH_TOKEN_KEY);
                showLoginScreen();
                showNotification('会话已过期，请重新登录', 'error');
                throw new Error('未授权');
            }
            return response;
        }
        
        async function checkServiceStatus() {
            const indicator = document.getElementById('service-status-indicator');
            const statusText = document.getElementById('service-status-text');
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'UP') {
                    indicator.className = 'status-indicator bg-secondary';
                    statusText.textContent = '正常运行';
                } else {
                    indicator.className = 'status-indicator bg-danger';
                    statusText.textContent = '未正常运行';
                }
            } catch (error) {
                indicator.className = 'status-indicator bg-danger';
                statusText.textContent = '未正常运行';
            }
        }
        
        async function loadKeys() {
            const tableBody = document.getElementById('keys-table-body');
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/keys`);
                const { keys, stats } = await response.json();
                renderKeysTable(keys);
                updateStats(keys, stats);
            } catch (error) {
                if (error.message !== '未授权') {
                    tableBody.innerHTML = `
                        <tr><td colspan="7" class="px-6 py-20 text-center text-gray-500">
                            <i class="fa fa-exclamation-triangle text-warning text-3xl mb-4"></i>
                            <p>加载失败: ${error.message}</p>
                            <button onclick="loadKeys()" class="mt-4 text-primary">重试</button>
                        </td></tr>
                    `;
                }
            }
        }
        
        function renderKeysTable(keys) {
            const tableBody = document.getElementById('keys-table-body');
            
            if (keys.length === 0) {
                tableBody.innerHTML = `
                    <tr><td colspan="7" class="px-6 py-20 text-center text-gray-500">
                        <i class="fa fa-key text-gray-300 text-3xl mb-4"></i>
                        <p>暂无API密钥，请添加新密钥</p>
                    </td></tr>
                `;
                return;
            }
            
            tableBody.innerHTML = keys.map(key => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">${key.id}</td>
                    <td class="px-6 py-4">${maskApiKey(key.key)}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mr-2">
                                <div class="bg-primary h-2.5 rounded-full" style="width: ${key.remainingQuotaPercentage}%"></div>
                            </div>
                            <span>${key.remainingQuota} / ${key.totalQuota}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">${key.todayUsage || 0}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs rounded-full ${getStatusBadgeClass(key.status)}">
                            ${getStatusText(key.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4">${formatDate(key.lastChecked)}</td>
                    <td class="px-6 py-4">
                        <button onclick="testKey('${key.id}')" class="text-primary mr-3">测试</button>
                        <button onclick="deleteKey('${key.id}')" class="text-danger">删除</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addNewKey() {
            const apiKey = document.getElementById('api-key').value;
            const keyName = document.getElementById('key-name').value;
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/keys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: apiKey, name: keyName })
                });
                
                if (response.ok) {
                    document.getElementById('add-key-form').reset();
                    loadKeys();
                    showNotification('密钥添加成功', 'success');
                } else {
                    const { message } = await response.json();
                    throw new Error(message || '添加失败');
                }
            } catch (error) {
                if (error.message !== '未授权') {
                    showNotification(error.message, 'error');
                }
            }
        }
        
        async function testKey(keyId) {
            try {
                await fetchWithAuth(`${API_BASE_URL}/keys/${keyId}/test`, { method: 'POST' });
                loadKeys();
                showNotification('测试成功', 'success');
            } catch (error) {
                if (error.message !== '未授权') {
                    showNotification('测试失败', 'error');
                }
            }
        }
        
        async function deleteKey(keyId) {
            if (!confirm('确定删除？')) return;
            
            try {
                await fetchWithAuth(`${API_BASE_URL}/keys/${keyId}`, { method: 'DELETE' });
                loadKeys();
                showNotification('已删除', 'success');
            } catch (error) {
                if (error.message !== '未授权') {
                    showNotification('删除失败', 'error');
                }
            }
        }
        
        function updateStats(keys, stats) {
            document.getElementById('total-keys').textContent = keys.length;
            document.getElementById('active-keys').textContent = keys.filter(k => k.status === 'ACTIVE').length;
            document.getElementById('today-requests').textContent = stats?.todayRequests || 0;
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');
            const msgEl = document.getElementById('notification-message');
            
            notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center ${
                type === 'success' ? 'bg-secondary text-white' : 'bg-danger text-white'
            }`;
            icon.className = `fa ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2`;
            msgEl.textContent = message;
            
            setTimeout(() => {
                notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center';
            }, 3000);
        }
        
        // 工具函数
        function formatDate(dateString) {
            return dateString ? new Date(dateString).toLocaleString() : '从未检查';
        }
        
        function maskApiKey(key) {
            return key.length > 8 ? key.substring(0, 4) + '...' + key.substring(key.length - 4) : key;
        }
        
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'ACTIVE': return 'bg-green-100 text-green-800';
                case 'EXHAUSTED': return 'bg-red-100 text-red-800';
                case 'INVALID': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function getStatusText(status) {
            switch(status) {
                case 'ACTIVE': return '可用';
                case 'EXHAUSTED': return '已用尽';
                case 'INVALID': return '无效';
                default: return '未知';
            }
        }
    </script>
</body>
</html>
    